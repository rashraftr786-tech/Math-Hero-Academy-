<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Hero Academy & Fractions</title>
    <style>
        :root { --primary: #4CAF50; --secondary: #2196F3; --accent: #ff9800; --fraction-bg: #fff3e0; }
        body { font-family: 'Comic Sans MS', cursive; background: #eef9ff; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* Navigation Bar */
        .nav { background: white; padding: 15px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; border: 3px solid var(--secondary); }
        .nav-btn { border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; background: #f0f0f0; transition: 0.3s; }
        .nav-btn.active { background: var(--secondary); color: white; transform: scale(1.05); }

        .main-layout { display: flex; gap: 20px; width: 100%; max-width: 1200px; }

        /* Sidebar Leaderboard */
        .sidebar { width: 250px; background: white; border-radius: 30px; border: 4px solid var(--accent); padding: 15px; box-shadow: 0 6px 0 var(--accent); }
        .student-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .me { background: #fff9c4; font-weight: bold; }

        /* Game Arena */
        .arena { flex: 1; background: white; border-radius: 40px; border: 8px solid var(--primary); padding: 30px; box-shadow: 0 10px 0 #2e7d32; min-height: 550px; text-align: center; }

        /* Fraction Exercise Styles */
        .fraction-circle { width: 150px; height: 150px; border: 4px solid #333; border-radius: 50%; margin: 20px auto; position: relative; overflow: hidden; background: white; }
        .slice { position: absolute; width: 100%; height: 100%; transform-origin: 50% 50%; border: 1px solid #333; }
        .shaded { background: var(--accent); }

        /* Common Math Styles */
        .math-box { font-size: 4rem; font-weight: bold; text-align: right; letter-spacing: 12px; font-family: 'Courier New', monospace; margin: 20px 0; padding-right: 40px; }
        .digit { width: 50px; height: 75px; font-size: 3rem; text-align: center; border: 3px solid var(--primary); border-radius: 10px; font-weight: bold; outline: none; }
        .ans-row { display: flex; justify-content: center; gap: 10px; }
        .divider { border-bottom: 6px solid #333; width: 80%; margin: 10px auto; }

        /* Certificate Modal */
        #cert-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
        .cert-box { background: white; padding: 20px; border-radius: 20px; text-align: center; width: 80%; max-width: 600px; border: 10px double gold; }
    </style>
</head>
<body>

    <div class="score-box" style="margin-bottom:10px; font-size:1.5rem;">‚≠ê Total Stars: <span id="stars-display">0</span></div>

    <div class="nav">
        <button class="nav-btn active" id="btn-sub" onclick="setView('subtraction')">‚ûñ Subtraction</button>
        <button class="nav-btn" id="btn-tab" onclick="setView('tables')">‚úñÔ∏è Tables</button>
        <button class="nav-btn" id="btn-frac" onclick="setView('fractions')">üç∞ Fractions</button>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <h3>üèÜ Leaders</h3>
            <div id="leaderboard"></div>
        </div>

        <div class="arena" id="arena">
            <div id="subtraction-view">
                <h2 style="color:var(--primary)">Subtraction Hero</h2>
                <div class="math-box" id="sub-q">9876<br>- 1234</div>
                <div class="divider"></div>
                <div class="ans-row">
                    <input type="text" id="d3" class="digit" maxlength="1">
                    <input type="text" id="d2" class="digit" maxlength="1">
                    <input type="text" id="d1" class="digit" maxlength="1">
                    <input type="text" id="d0" class="digit" maxlength="1">
                </div>
                <button class="nav-btn active" style="margin-top:20px;" onclick="checkSub()">Check Answer</button>
            </div>

            <div id="fractions-view" style="display:none">
                <h2 style="color:var(--accent)">Fraction Fun!</h2>
                <div id="fraction-visual" style="display:flex; justify-content:center; gap:20px; margin:20px 0;">
                    </div>
                <p style="font-size:1.5rem">What fraction is shaded?</p>
                <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                    <input type="number" id="frac-num" style="width:60px; font-size:2rem; text-align:center;">
                    <span style="font-size:3rem">/</span>
                    <input type="number" id="frac-den" style="width:60px; font-size:2rem; text-align:center;">
                </div>
                <button class="nav-btn active" style="margin-top:20px; background:var(--accent);" onclick="checkFraction()">Submit</button>
            </div>

            <div id="tables-view" style="display:none">
                <h2>Unlocked Tables</h2>
                <div id="table-tower" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;"></div>
            </div>
        </div>
    </div>

    <div id="cert-modal">
        <div class="cert-box">
            <h1 style="color:gold; font-size:3rem">ü•á CERTIFICATE</h1>
            <p style="font-size:1.5rem">Congratulations, <strong>Student 3</strong>!</p>
            <p id="cert-text">You have mastered 4-Digit Subtraction!</p>
            <button onclick="downloadCert()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:10px; cursor:pointer;">Download Image</button>
            <button onclick="document.getElementById('cert-modal').style.display='none'" style="padding:10px 20px; background:red; color:white; border:none; border-radius:10px; cursor:pointer;">Close</button>
            <canvas id="certCanvas" width="600" height="400" style="display:none;"></canvas>
        </div>
    </div>

    <script>
        let stars = parseInt(localStorage.getItem('mathStars')) || 0;
        let subSolved = parseInt(localStorage.getItem('subSolved')) || 0;
        let fracCurrent = { n: 1, d: 2 };

        // RIGHT-TO-LEFT SUBTRACTION
        const boxes = [document.getElementById('d0'), document.getElementById('d1'), document.getElementById('d2'), document.getElementById('d3')];
        boxes.forEach((box, i) => {
            box.addEventListener('input', () => { if(box.value && i < 3) boxes[i+1].focus(); });
            box.addEventListener('keydown', (e) => { if(e.key === 'Backspace' && !box.value && i > 0) boxes[i-1].focus(); });
        });

        function setView(view) {
            ['subtraction-view', 'fractions-view', 'tables-view'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById(view + '-view').style.display = 'block';
            if(view === 'fractions') generateFraction();
        }

        // FRACTION LOGIC
        function generateFraction() {
            const d = [2, 3, 4, 6, 8][Math.floor(Math.random()*5)];
            const n = Math.floor(Math.random() * (d - 1)) + 1;
            fracCurrent = { n, d };
            
            const visual = document.getElementById('fraction-visual');
            visual.innerHTML = `<div class="fraction-circle" id="f-circle"></div>`;
            const circle = document.getElementById('f-circle');
            
            for(let i=0; i<d; i++) {
                const slice = document.createElement('div');
                slice.className = 'slice' + (i < n ? ' shaded' : '');
                slice.style.transform = `rotate(${(360/d)*i}deg) skewY(${90 - (360/d)}deg)`;
                circle.appendChild(slice);
            }
        }

        function checkFraction() {
            const userN = parseInt(document.getElementById('frac-num').value);
            const userD = parseInt(document.getElementById('frac-den').value);
            if(userN === fracCurrent.n && userD === fracCurrent.d) {
                alert("YUM! üç∞ +10 Stars!");
                updateStars(10);
                generateFraction();
                document.getElementById('frac-num').value = '';
                document.getElementById('frac-den').value = '';
            } else { alert("Try again!"); }
        }

        // SUBTRACTION LOGIC
        function checkSub() {
            const val = parseInt(boxes[3].value + boxes[2].value + boxes[1].value + boxes[0].value);
            // Simulating a win for 1234 - 1111 style logic
            if(val === 8642) { // Based on the mock 9876-1234
                updateStars(5);
                subSolved++;
                localStorage.setItem('subSolved', subSolved);
                if(subSolved === 5) showCert("4-Digit Subtraction Expert");
            } else { alert("Check your math!"); }
        }

        // CERTIFICATE LOGIC
        function showCert(title) {
            document.getElementById('cert-text').innerText = "Awarded for: " + title;
            document.getElementById('cert-modal').style.display = 'flex';
        }

        function downloadCert() {
            const canvas = document.getElementById('certCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0,0,600,400);
            ctx.strokeStyle = "gold"; ctx.lineWidth = 20; ctx.strokeRect(20,20,560,360);
            ctx.fillStyle = "black"; ctx.font = "30px Comic Sans MS"; ctx.textAlign = "center";
            ctx.fillText("MATH HERO ACADEMY", 300, 80);
            ctx.font = "20px Arial"; ctx.fillText("This Certificate is Awarded to Student 3 for:", 300, 150);
            ctx.font = "bold 25px Arial"; ctx.fillText(document.getElementById('cert-text').innerText, 300, 200);
            ctx.font = "40px Arial"; ctx.fillText("üèÜ", 300, 300);
            
            const link = document.createElement('a');
            link.download = 'certificate.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function updateStars(n) {
            stars += n;
            localStorage.setItem('mathStars', stars);
            document.getElementById('stars-display').innerText = stars;
        }

        // INIT
        document.getElementById('stars-display').innerText = stars;
        const lb = document.getElementById('leaderboard');
        for(let i=1; i<=10; i++) lb.innerHTML += `<div class="student-item ${i==3?'me':''}"><span>${i}. Student ${i}</span><span>${i==3?stars:100-i} ‚≠ê</span></div>`;

    </script>
</body>
</html>
